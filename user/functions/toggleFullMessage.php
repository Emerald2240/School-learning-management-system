<?php
require_once('../config/connect.php');
require_once('functions.php');
//die;

if (!isset($_GET['announcement_id'])) {
    //print json_encode([['error' => 'Unknown Error Occured']]);
} else {
    extract($_GET);
    switch ($_GET) {
        case (!empty($announcement_id)):
            $announcementInfo = getAnnouncementInfo($announcement_id);
            $viewers = json_decode($announcementInfo['viewers'], true);
            if (empty($viewers)) {
                $viewers = [];
            }

            if ($announcementInfo) {
                if (!empty($viewers)  && isset($viewers[0])) {
                    if (!hasStudentViewed($_SESSION['student_id'], $viewers)) {
                        $newViewer = array('id' => $_SESSION['student_id']);
                        array_push($viewers, $newViewer);
                        markAnnouncementRead($announcementInfo['id'], $viewers);

                        $announcements = getAllAnnouncementsForStudent($_SESSION['student_reg']);
                        $readAnnouncements = getReadOrUnreadAnnouncements($announcements, $_SESSION['student_id']);
                        $unreadAnnouncements = getReadOrUnreadAnnouncements($announcements, $_SESSION['student_id'], true);

                        $_SESSION['read_announcemts'] = count($readAnnouncements);
                        $_SESSION['unread_announcements'] = count($unreadAnnouncements);
                    }
                }


                echo html_entity_decode($announcementInfo['description']);
                // echo $announcementInfo['description'];
            } else {
                echo 'error';
                //print json_encode([['error' => 'DB Error Occured']]);
            }
            break;
        default:
            //print json_encode([['error' => 'Data Missing']]);
            break;
    }
}
//['first_name', 'last_name','student_gender', 'student_email', 'student_phone', 'student_reg','student_department', 'password1', 'password2', 'agree']